# Mining - Activation Transaction

Miners become eligible to mine in Spacemesh by publishing an Activation Transaction (ATX). Each ATX is a publicly verifiable, self-contained proof that the miner committed some space-time resources to the protocol. This document describes how the theory described in the previous documents (PoST, PoET, NIPoST) is put into practice in the production Spacemesh protocol. In particular, it explains how the NIPoST (which itself contains the PoST and PoET) is wrapped, with accompanying metadata, into an ATX and used in the Spacemesh protocol.


## Epochs and eligibility

In Spacemesh, multiple blocks are produced at each block height: the set of blocks produced at a given height is known as a _layer._ Time is divided into _epochs_, where an epoch is a fixed number of layers (unlike protocols like Bitcoin where blocks are produced probabilistically, and thus at random intervals, in Spacemesh the length of time between each layer is perfectly fixed and always the same). Every miner publishes one ATX per epoch, which causes the protocol to consider them “active” in the following epoch.

Due to the [race-free nature of the Spacemesh protocol](https://spacemesh.io/race-freeness/), being “active” guarantees a miner eligibility to produce blocks. The reward calculation and total voting weight of the blocks produced by a given miner in the consensus protocol are proportional to the space-time resources attested to by that miner in the NIPoST (contained in their ATX). An active miner is also eligible to participate in Hare consensus protocol [LINK forthcoming].

An epoch is long enough that each active miner should be able to generate at least one block per epoch (and probably many more)—e.g., if there are 100,000 active miners, and 200 blocks per layer, each epoch should be at least 500 layers long. The positions of a given miner’s blocks within layers in the epoch and the participation period in the Hare protocol are selected using a random beacon [LINK forthcoming], a source of randomness that is unpredictable and unbiasable by an adversary. This is necessary to ensure (with high probability) that the majority of blocks in every layer is generated by honest parties.

[Consider adding an illustration or animation here to make it clearer how and when ATXs are generated, broadcasted, stored, etc.]


## Construction

Unlike the [PoST](02-post.md) and [PoET](03-poet.md) constructions, an ATX is not itself a proof and as such it does not require any additional commitment of resources or complex computation. Instead, like [NIPoST](04-nipost.md), it’s a data structure that wraps the ATX along with relevant metadata. An ATX is a “freestanding” transaction—it does not have to be included in a block to be valid, but can just be gossiped to the network.

In addition to the full NIPoST attested to by the ATX, the ATX also contains fields such as the ID of the previous ATX from the same miner, the time when the eligibility for this ATX starts and ends, and the miner’s signature. See [some other doc] for an elaboration of the full contents of the ATX.

Each ATX contains the following components:


1. **Node ID**: a tuple (_vkid, vrf_id_), where vk_id is a verification key for a signature scheme and vrf_id is the verification key for a VRF. 
2. **Sequence number** _s_: a sequence number (ATXs for a given Node ID must be published in sequence). 
3. **Previous ATX**: the ID of the ATX with the same Node ID and sequence number _s_− 1. (if _s_= 0, then this field is empty). 
4. **Layer Index** _i_: the index of the layer at which this ATX becomes valid. 
5. **Positioning ATX**: the ID of an ATX (not necessarily with the same Node ID) with a layer index _i_−∆epoch. Miners should always choose the ATX with the highest end-tick at layer _i_−∆epoch.
6. **Start tick** t: The “sequential work tick” at which this ATX starts. This is equal to the end tick of t
7. **End tick** t′: the sequential work tick at which this ATX ends.
8. **NIPoST**: a NIPoST proof using the Node ID as the ID and a hash of all the previous fields as the challenge. The NIPoST duration must be t′ − t.
9. **Active set size** d: the number of “active” ATXs seen by the node creating this ATX at the time it is published (note that d is not an input to the NIPoST).
10. **View pointers**: pointers (IDs) of blocks whose combined visible mesh (see section 4.5) includes d active ATXs. (This will usually be a single block, but can include explicit pointers to ATXs not in any block.)
11. **Signature**: A signature of the ATX ID (the hash of the ATX excluding the signature) using the private key corresponding to vkid.


## Validity

Every valid block [LINK forthcoming] contains a pointer to a valid ATX that authorizes the miner in question to produce a block in the epoch and layer where the block was produced. In order to determine whether a given block is valid, a miner first fetches the ATX that the block points to, and validates that ATX. The ATX is considered valid if it has a valid signature from the miner, if no duplicate ATX was published, if the NIPoST it contains is valid, and if the time indicated by the ATX matches the duration attested to by the NIPoST. These validation rules prevent a dishonest miner from pre-generating ATXs for multiple identities, reusing the same storage space, and publishing them all in a single future epoch. See [some other doc] for a full elaboration of the validation rules for an ATX.

An ATX is syntactically valid [LINK forthcoming] if it satisfies the following conditions:

*   The signature verifies
*   No other ATX was published with the same ID and sequence number
*   If _s_!= 0 then the Previous ATX is valid and its sequence number is _s_− 1.

    Together with the previous condition, this ensures that each ATX requires its own resource expenditure; without the sequence numbers, it would be possible for an adversary to run several NIPoSTs _in parallel_ for a given storage space, thus generating several ATXs but expending space-time only once. \
Note that the ATX is _mature _iff _s _≥ _k_.

*   The Positioning ATX is valid and its end tick is _t_.
*   The NIPoST verifies with Node ID as its ID, _D_ as its duration and a hash of fields 1 to 7 as its challenge (this ensures that the ATX can only have been generated _D_ ticks after the Positioning and Previous ATXs).
*   The layer index _i_′ of the positioning ATX satisfies _i_− _i_′ < _D_/layertime, where _D_ is the NIPoST duration.

    Together with the previous conditions, this ensures that an adversary can’t “shift” its resources into the future; without a Positioning ATX, the adversary could generate valid ATXs with layer numbers in the future. This would allow the adversary to concentrate resources in a short period by shifting multiple IDs to the same future timeslot (e.g., it generates ATXs for different identities one after another—reusing the same space—but publishes all of them in a single future epoch.)

*   The ATX’s view contains _d _active IDs. \
(This ensures that the adversary can’t inflate _d_; doing so would allow it to reduce the number of blocks it generates per epoch, concentrating its voting weight on fewer layers)


## Conclusion

Congratulations, dear reader, on making it to the bottom of this deep, dark rabbit hole! With all of the building blocks in place—PoST, PoET, NIPoST, and ATX—you now fully understand all of the components of the Proof of Space-time protocol underlying the Spacemesh blockchain, and how they fit together to allow miners to prove in a publicly verifiable, self-contained, non-interactive fashion that they’ve committed a certain amount of space-time resources to the protocol. Continue to learn about the other parts of the protocol by reading about the consensus mechanism [LINK forthcoming], P2P network [LINK forthcoming], and data structures [LINK forthcoming].
